generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- –ö–û–†–ò–°–¢–£–í–ê–ß–Ü –¢–ê –ü–†–û–§–Ü–õ–¨---

model User {
  id                      Int       @id @default(autoincrement())
  email                   String    @unique
  username                String    @unique
  password                String    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ö–µ—à –ø–∞—Ä–æ–ª—è
  
  // --- –ü–†–û–§–Ü–õ–¨ ---
  avatarUrl               String?
  displayName             String?             // –í—ñ–¥–æ–±—Ä–∞–∂—É–≤–∞–Ω–µ —ñ–º'—è
  bio                     String?
  timezone                String?             // Europe/Kyiv - –¥–ª—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è —Å–µ—Å—ñ–π
  language                String?   @default("uk") // –ú–æ–≤–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
  
  // --- –ú–ï–¢–ê-–î–ê–ù–Ü ---
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  lastActiveAt            DateTime?           // –û—Å—Ç–∞–Ω–Ω—ñ–π –≤—ñ–∑–∏—Ç

  // üîê –†–µ—Å–µ—Ç –ø–∞—Ä–æ–ª—è
  passwordResetToken      String?   @unique
  passwordResetExpiry     DateTime?

  // –ó–≤'—è–∑–∫–∏
  wallet                  Wallet?   // –û–¥–∏–Ω –≥–∞–º–∞–Ω–µ—Ü—å –Ω–∞ —é–∑–µ—Ä–∞
  stats                   UserStats? // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  
  // –£—á–∞—Å—Ç—å —É –∫–∞–º–ø–∞–Ω—ñ—è—Ö —Ç–∞ —Å–µ—Å—ñ—è—Ö
  campaignsOwned          Campaign[] @relation("OwnerCampaigns") // –ö–∞–º–ø–∞–Ω—ñ—ó, –¥–µ –≤—ñ–Ω –≤–ª–∞—Å–Ω–∏–∫
  campaignMembers         CampaignMember[] // –ß–ª–µ–Ω—Å—Ç–≤–æ –≤ –∫–∞–º–ø–∞–Ω—ñ—è—Ö
  sessionsJoined          SessionParticipant[] // –°–µ—Å—ñ—ó, –¥–µ –≤—ñ–Ω –≥—Ä–∞–≤–µ—Ü—å/–º–∞–π—Å—Ç–µ—Ä
  createdSessions         Session[] @relation("CreatedSessions") // –°–µ—Å—ñ—ó, —è–∫—ñ –≤—ñ–Ω —Å—Ç–≤–æ—Ä–∏–≤
  
  // –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø
  joinRequests            JoinRequest[]
  reviewedJoinRequests    JoinRequest[] @relation("ReviewedBy")
  
  // –ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è
  messages                ChatMessage[] // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç–∞—Ö
  emailVerified            Boolean   @default(false)
  refreshTokens           RefreshToken[]

  emailVerificationTokens EmailVerificationToken[]
  emailChangeTokens       EmailChangeToken[]
}

model Wallet {
  id      Int     @id @default(autoincrement())
  balance Float   @default(0.0)
  userId  Int     @unique
  user    User    @relation(fields: [userId], references: [id])
  
  transactions Transaction[] // –Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–ª–∞—Ç
}

model UserStats {
  id             Int @id @default(autoincrement())
  hoursPlayed    Int @default(0)
  sessionsPlayed Int @default(0)
  userId         Int @unique
  user           User @relation(fields: [userId], references: [id])
}

// --- –ö–ê–ú–ü–ê–ù–Ü–á –¢–ê –°–ï–°–Ü–á ---

model Campaign {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  imageUrl    String?                           // –û–±–∫–ª–∞–¥–∏–Ω–∫–∞
  system      String?                           // D&D 5e, Pathfinder, —Ç–æ—â–æ
  
  visibility  CampaignVisibility @default(PRIVATE)
  inviteCode  String?   @unique                // –î–ª—è LINK_ONLY
  
  ownerId     Int
  owner       User      @relation("OwnerCampaigns", fields: [ownerId], references: [id])
  
  members     CampaignMember[]                 // –£—á–∞—Å–Ω–∏–∫–∏ –∫–∞–º–ø–∞–Ω—ñ—ó
  sessions    Session[]                        // –ö–∞–º–ø–∞–Ω—ñ—è –º–∞—î –±–∞–≥–∞—Ç–æ —Å–µ—Å—ñ–π
  joinRequests JoinRequest[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum CampaignVisibility {
  PUBLIC      // –í–∏–¥–Ω–æ –≤ –ø–æ—à—É–∫—É
  PRIVATE     // –¢—ñ–ª—å–∫–∏ –¥–ª—è —É—á–∞—Å–Ω–∏–∫—ñ–≤
  LINK_ONLY   // –î–æ—Å—Ç—É–ø –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º
}

// === –£—á–∞—Å–Ω–∏–∫–∏ –∫–∞–º–ø–∞–Ω—ñ—ó ===
model CampaignMember {
  id         Int          @id @default(autoincrement())
  role       CampaignRole @default(PLAYER)
  joinedAt   DateTime     @default(now())
  
  userId     Int
  user       User         @relation(fields: [userId], references: [id])
  
  campaignId Int
  campaign   Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@unique([userId, campaignId])
}

enum CampaignRole {
  OWNER
  GM
  PLAYER
}

model Session {
  id          Int           @id @default(autoincrement())
  title       String
  description String?
  
  date        DateTime                        // –î–∞—Ç–∞ —ñ —á–∞—Å –ø–æ—á–∞—Ç–∫—É (UTC)
  duration    Int           @default(180)     // –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –≤ —Ö–≤–∏–ª–∏–Ω–∞—Ö
  
  status      SessionStatus @default(PLANNED) // Active, Planned, Finished
  visibility  CampaignVisibility @default(PRIVATE)  // –ù–∞—Å–ª—ñ–¥—É—î –≤—ñ–¥ –∫–∞–º–ø–∞–Ω—ñ—ó –∞–±–æ –æ–∫—Ä–µ–º–æ
  
  price       Float     @default(0.0)         // –¶—ñ–Ω–∞ –∑–∞ –≥—Ä—É
  maxPlayers  Int       @default(4)
  
  system      String?                         // D&D 5e, Pathfinder 2e, —Ç–æ—â–æ
                                              // –ö–æ–ø—ñ—é—î—Ç—å—Å—è –∑ –∫–∞–º–ø–∞–Ω—ñ—ó –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ
                                              // –∞–±–æ –∑–∞–¥–∞—î—Ç—å—Å—è –≤—Ä—É—á–Ω—É –¥–ª—è one-shot
  
  campaignId  Int?                            // Nullable –¥–ª—è one-shots
  campaign    Campaign? @relation(fields: [campaignId], references: [id])
  
  creatorId   Int                             // –•—Ç–æ —Å—Ç–≤–æ—Ä–∏–≤ (GM)
  creator     User      @relation("CreatedSessions", fields: [creatorId], references: [id])
  
  participants SessionParticipant[]
  messages     ChatMessage[]                  // –ß–∞—Ç —Å–µ—Å—ñ—ó 
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([date, system])                     // –ö–æ–º–ø–æ–∑–∏—Ç–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –ø–æ –¥–∞—Ç—ñ –¢–ê —Å–∏—Å—Ç–µ–º—ñ
}

// –¢–∞–±–ª–∏—Ü—è –∑–≤'—è–∑–∫—É: –•—Ç–æ —î —Ö—Ç–æ –≤ —Å–µ—Å—ñ—ó 
model SessionParticipant {
  id        Int              @id @default(autoincrement())
  role      SessionRole      @default(PLAYER)
  status    ParticipantStatus @default(PENDING)  // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ —É—á–∞—Å—Ç—å?
  isGuest   Boolean          @default(false)     // –ì—ñ—Å—Ç—å (–Ω–µ —á–ª–µ–Ω –∫–∞–º–ø–∞–Ω—ñ—ó)
  
  userId    Int
  sessionId Int
  
  user      User    @relation(fields: [userId], references: [id])
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId]) // –Æ–∑–µ—Ä –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –¥–≤—ñ—á—ñ –≤ –æ–¥–Ω—ñ–π –≥—Ä—ñ
}

enum SessionRole {
  GM
  PLAYER
}

enum ParticipantStatus {
  PENDING     // –ó–∞–ø—Ä–æ—à–µ–Ω–∏–π, –∞–ª–µ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤
  CONFIRMED   // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ —É—á–∞—Å—Ç—å
  DECLINED    // –í—ñ–¥–º–æ–≤–∏–≤—Å—è
  ATTENDED    // –ë—É–≤ –ø—Ä–∏—Å—É—Ç–Ω—ñ–π (–ø—ñ—Å–ª—è –≥—Ä–∏)
  NO_SHOW     // –ù–µ –∑'—è–≤–∏–≤—Å—è
}

// === –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø –¥–æ –∫–∞–º–ø–∞–Ω—ñ—ó ===
model JoinRequest {
  id         Int              @id @default(autoincrement())
  status     JoinRequestStatus @default(PENDING)
  message    String?                           // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –∑–∞—è–≤–Ω–∏–∫–∞
  
  userId     Int
  user       User             @relation(fields: [userId], references: [id])
  
  campaignId Int
  campaign   Campaign         @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime         @default(now())
  reviewedAt DateTime?
  reviewedBy Int?
  reviewer   User?            @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  
  @@unique([userId, campaignId])
}

enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model EmailVerificationToken {
  id          Int      @id @default(autoincrement())
  token       String   @unique
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

// –¢–æ–∫–µ–Ω –¥–ª—è –∑–º—ñ–Ω–∏ email
model EmailChangeToken {
  id          Int      @id @default(autoincrement())
  token       String   @unique
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  newEmail    String   // –ù–æ–≤–∏–π email, –Ω–∞ —è–∫–∏–π –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

// --- –ö–û–ú–£–ù–Ü–ö–ê–¶–Ü–Ø –¢–ê –§–Ü–ù–ê–ù–°–ò ---

model ChatMessage {
  id        Int      @id @default(autoincrement())
  text      String
  createdAt DateTime @default(now())
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  
  sessionId Int
  session   Session  @relation(fields: [sessionId], references: [id])
}

model Transaction {
  id        Int      @id @default(autoincrement())
  amount    Float
  type      String   // "DEPOSIT" –∞–±–æ "PAYMENT"
  date      DateTime @default(now())
  
  walletId  Int
  wallet    Wallet   @relation(fields: [walletId], references: [id])
}

// --- ENUMS (–°–ø–∏—Å–∫–∏ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤) ---

enum SessionStatus {
  PLANNED
  ACTIVE
  FINISHED
  CANCELED
}

model RefreshToken {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  revoked    Boolean  @default(false)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
}